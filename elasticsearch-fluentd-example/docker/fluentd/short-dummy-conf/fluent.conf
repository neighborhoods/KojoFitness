<source>
  @type dummy
  dummy [
         { "partial_message": "true", "@timestamp": "2019-04-02T14:29:06+00:00", "@log_name": "kojo_fitness", "log": "{\"time\":\"Tue, 02 Apr 19 14:29:06.636533 UTC\",\"level\":\"critical\",\"message\":\"This is the last one\",\"context\":{\"exception_string\":\"a" },
         { "partial_message": "true", "@timestamp": "2019-04-02T14:29:06+00:00", "@log_name": "kojo_fitness", "log": "b" },
         { "partial_message": "true", "@timestamp": "2019-04-02T14:29:06+00:00", "@log_name": "kojo_fitness", "log": "c" },
         { "partial_message": "true", "@timestamp": "2019-04-02T14:29:06+00:00", "@log_name": "kojo_fitness", "log": "d" },
         { "partial_message": "true", "@timestamp": "2019-04-02T14:29:06+00:00", "@log_name": "kojo_fitness", "log": "e" },
         { "partial_message": "true", "@timestamp": "2019-04-02T14:29:06+00:00", "@log_name": "kojo_fitness", "log": "f" },
         { "partial_message": "true", "@timestamp": "2019-04-02T14:29:06+00:00", "@log_name": "kojo_fitness", "log": "g\"},\"context_json_last_error\":0}" },
         { "@timestamp": "2019-04-02T14:45:05+00:00", "@log_name": "kojo_fitness", "log": "{\"time\":\"Tue, 02 Apr 19 14:45:05.507961 UTC\",\"level\":\"notice\",\"message\":\"new_worker\",\"context\":{\"job_type\":\"complex_logging_structure\",\"event_type\":\"new_worker\"},\"context_json_last_error\":0}" }
        ]
  tag dummy
</source>
<source>
  @type prometheus
  bind 0.0.0.0
  port 24231
  metrics_path /metrics
</source>
<source>
  @type prometheus_output_monitor
  interval 10
  <labels>
    hostname ${hostname}
  </labels>
</source>


<match **>
  @type copy
  <store>
    @type relabel
    @label @JOIN
  </store>
  <store>
    @type relabel
    @label @RAW
  </store>
</match>

<label @RAW>
    <match **>
      @type copy
      <store>
        @type elasticsearch
        host docker.for.mac.localhost
        port 9201
        logstash_format true
        logstash_prefix raw
        logstash_dateformat %Y%m%d
        include_tag_key true
        type_name access_log
        tag_key @log_name
        flush_interval 1s
      </store>
    </match>
</label>

<label @JOIN>
    <filter>
      @type concat
      key log
      partial_key partial_message
      partial_value true
      keep_partial_key true
      separator ""
    </filter>

    <match **>
      @type copy
      <store>
        @type elasticsearch
        host docker.for.mac.localhost
        port 9201
        logstash_format true
        logstash_prefix post-join
        logstash_dateformat %Y%m%d
        include_tag_key true
        type_name access_log
        tag_key @log_name
        flush_interval 1s
      </store>
      <store>
        @type relabel
        @label @JOINED
      </store>
    </match>
</label>

<label @JOINED>
    <filter **>
      @type parser
      format json
      key_name log
      reserve_data true
      time_format  %a, %d %b %y %T.%N
      emit_invalid_record_to_error true
    </filter>

    <match fluent.*>
        @type copy
        <store>
          @type elasticsearch
          host docker.for.mac.localhost
          port 9201
          logstash_format true
          logstash_prefix fluentd
          logstash_dateformat %Y%m%d
          include_tag_key true
          type_name access_log
          tag_key @log_name
          flush_interval 1s
        </store>
        <store>
          @type stdout
        </store>
    </match>

    <filter **>
    @type record_transformer
    remove_keys log
    <record>
      meta_status "processed"
      meta_config_source "prod-fluent.conf: kojo label"
    </record>
    </filter>

    <match **>
      @type copy
      <store>
        @type elasticsearch
        host docker.for.mac.localhost
        port 9201
        logstash_format true
        logstash_prefix kojo-fitness-v1.0.0
        logstash_dateformat %Y%m%d
        include_tag_key true
        type_name access_log
        tag_key @log_name
        flush_interval 1s
      </store>
    </match>
</label>

<label @ERROR>
  <match **>
    @type copy
    <store>
      @type elasticsearch
      host docker.for.mac.localhost
      port 9201
      logstash_format true
      logstash_prefix json-parse-error
      logstash_dateformat %Y%m%d
      include_tag_key true
      type_name access_log
      tag_key @log_name
      flush_interval 1s
    </store>
  </match>
</label>
